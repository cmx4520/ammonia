<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¨åˆæˆäº§ç‡è®¡ç®—å™¨ (é…æ¶²æŒ‡å—ç‰ˆ)</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f6f8; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: #333; padding: 20px; margin: 0; }
        
        /* --- å¸ƒå±€å®¹å™¨ --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 20px;
            max-width: 1300px;
            margin: 0 auto;
            margin-top: 40px; /* ç»™é¡¶éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        @media (max-width: 1000px) {
            .main-container { grid-template-columns: 1fr; }
        }

        .panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
        .tag { font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 4px; color: #666; font-weight: normal; }

        /* --- å·¦ä¸Šè§’ é…åˆ¶æŒ‡å—æŒ‰é’® --- */
        .guide-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .guide-btn:hover {
            background-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        /* --- æ¨¡æ€æ¡† (Modal) æ ·å¼ --- */
        .modal-overlay {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .close-modal {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        .close-modal:hover { color: var(--danger); }
        
        /* æŒ‡å—æ–‡æœ¬æ ·å¼ */
        .guide-section h3 { color: var(--accent); border-left: 4px solid var(--primary); padding-left: 10px; margin-top: 20px; }
        .guide-section ul { padding-left: 20px; }
        .guide-section li { margin-bottom: 8px; line-height: 1.6; }
        .chem-formula { font-family: "Georgia", serif; background: #f0f4f8; padding: 2px 5px; border-radius: 4px; }

        /* --- è¡¨æ ¼æ ·å¼ --- */
        table.data-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 14px; }
        table.data-table th { background: #f8f9fa; color: var(--primary); padding: 10px; border: 1px solid #e1e4e8; font-weight: 600; white-space: nowrap; }
        table.data-table td { border: 1px solid #e1e4e8; padding: 5px; text-align: center; vertical-align: middle; }
        
        .index-cell { background-color: #f9f9f9; color: #888; font-weight: bold; width: 40px; }
        .no-right-border { border-right: none !important; }
        .no-left-border { border-left: none !important; }

        /* --- è¾“å…¥æ¡†æ ·å¼ --- */
        input[type="number"] { 
            width: 90%; 
            padding: 8px; 
            border: 1px solid transparent; 
            text-align: center; 
            border-radius: 4px; 
            transition: 0.2s; 
            background: #fff; 
            -moz-appearance: textfield; 
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"]:focus { border-color: var(--accent); outline: none; background: #f0f8ff; }
        
        /* å‚æ•°åŒº */
        .params-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .input-wrapper label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600; }
        .input-wrapper input { width: 100%; border: 1px solid #ddd; padding: 8px; box-sizing: border-box; text-align: left; }
        
        /* æŒ‰é’® */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s; font-weight: 600; }
        .btn-add { background: #ecf0f1; color: #2c3e50; }
        .btn-del { background: #fff; color: #c0392b; padding: 4px 8px; font-weight: bold; border: 1px solid #fadbd8; }
        .btn-del:hover { background: #fadbd8; }
        .btn-success { background: var(--success); color: white; width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
        button:hover { opacity: 0.9; }

        .result-cell { font-weight: bold; color: var(--danger); font-size: 1.1em; }
        .auto-filled { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; color: #2e7d32; font-weight: bold; }
        
        #fit-status { margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 13px; color: #2e7d32; display: none; }
    </style>
</head>
<body>

<button class="guide-btn" onclick="openModal()">ğŸ§ª é›é…šè“æº¶æ¶²é…ç½®</button>

<div id="guideModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('guideModal').style.display='none'">&times;</span>
        <h2 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">é›é…šè“æ³•æº¶æ¶²é…ç½®æŒ‡å—</h2>
        
        <div class="guide-section">
            <h3>1. è¯•å‰‚ä¸æº¶æ¶² (Reagents)</h3>
            <ul>
                <li><strong>æ°¨æ ‡å‡†æº¶æ¶² (Stock Solution)</strong>ï¼š<br>ç§°å– 0.03537 g æ°¯åŒ–é“µ ($NH_4Cl$)ï¼Œæº¶äºå»ç¦»å­æ°´å¹¶å®šå®¹è‡³ 100 mLã€‚</li>
                
                <li><strong>ç¡«é…¸æ•è·æ¶² (Absorbent)</strong>ï¼š<br>ä½¿ç”¨å®éªŒå®¤æµ“ç¡«é…¸é…åˆ¶ã€‚æ ¹æ®å‚¬åŒ–å‰‚æ´»æ€§ï¼Œæµ“åº¦å¯è°ƒèŠ‚ä¸º 0.6ã€1ã€3ã€6 æˆ– 8 mmol/Lã€‚</li>
                
                <li><strong>æ°¢æ°§åŒ–é’ æº¶æ¶²</strong>ï¼š<br>æµ“åº¦ä¸º 0.5 mol/Lã€‚</li>
                
                <li><strong>æ˜¾è‰²å‰‚ A (è‹¯é…šæº¶æ¶²)</strong>ï¼š<br>ç§°å– 3.8 g è‹¯é…š + 40 mg äºšç¡é…°é“æ°°åŒ–é’ ï¼Œæº¶è§£å¹¶ç¨€é‡Šè‡³ 100 mLã€‚ç½®äºæ£•è‰²ç“¶ä¸­é¿å…‰ä¿å­˜ã€‚</li>
                
                <li><strong>æ˜¾è‰²å‰‚ B (æŸ æª¬é…¸é’ æº¶æ¶²)</strong>ï¼š<br>ç§°å– 48 g æŸ æª¬é…¸é’ æº¶äº 100 mL æ°´ï¼ŒåŠ å…¥ 4 mL 0.5 mol/L æ°¢æ°§åŒ–é’ æº¶æ¶²ã€‚ç…®æ²¸è‡³ä½“ç§¯ < 100 mL ä»¥é™¤æ°¨ï¼Œå†·å´åç”¨æ°´ç¨€é‡Šå› 100 mLã€‚</li>
                
                <li><strong>æ°§åŒ–æ¶² (æ¬¡æ°¯é…¸é’ æº¶æ¶²)</strong>ï¼š<br>å– 25 mL å¸‚å”®æ¬¡æ°¯é…¸é’ æº¶æ¶² + 25 mL 0.5 mol/L æ°¢æ°§åŒ–é’ æº¶æ¶²æ··åˆå‡åŒ€ã€‚</li>
            </ul>

            <h3>2. æµ‹å®šæ­¥éª¤ (Procedure)</h3>
            <ul>
                <li><strong>æ ‡å‡†æ›²çº¿ç»˜åˆ¶</strong>ï¼š<br>åœ¨ç¡«é…¸æ•è·æ¶²ä¸­åˆ†åˆ«åŠ å…¥ 0ã€90ã€180ã€270ã€360 $\mu L$ æ°¨æ ‡å‡†æº¶æ¶²ã€‚</li>
                <li><strong>æ˜¾è‰²ååº”</strong>ï¼š<br>å– 30 mL å¾…æµ‹æ¶²ï¼ˆæˆ–æ ‡å‡†æ¶²ï¼‰ + 1 mL æ˜¾è‰²å‰‚ B + 1 mL æ˜¾è‰²å‰‚ A + 1 mL æ°§åŒ–æ¶²ã€‚</li>
                <li><strong>æµ‹è¯•</strong>ï¼š<br>æ··åˆå‡åŒ€åé¿å…‰é™ç½®ï¼ˆé€šå¸¸1-2å°æ—¶ï¼‰ï¼Œæµ‹è¯•ç´«å¤–å¸å…‰åº¦ã€‚</li>
            </ul>
        </div>
    </div>
</div>

<div class="main-container">
    
    <div class="panel">
        <h2>1. æ ‡å‡†æ›²çº¿æ‹Ÿåˆ <span class="tag">Standard Curve</span></h2>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">è¾“å…¥æ ‡æ¶²æµ“åº¦ä¸å¸å…‰åº¦ï¼Œè®¡ç®—æ–œç‡ã€‚</p>
        
        <table class="data-table" id="curveTable">
            <thead>
                <tr>
                    <th>æµ“åº¦ $C$ <br><span style="font-weight:normal; font-size:0.9em">($\mu g/mL$)</span></th>
                    <th>å¸å…‰åº¦ $Abs$</th>
                    <th class="no-left-border" style="width:40px"></th>
                </tr>
            </thead>
            <tbody>
                <tr><td><input type="number" step="0.01" value="0"></td><td class="no-right-border"><input type="number" step="0.001" value="0"></td><td class="no-left-border"></td></tr>
                <tr><td><input type="number" step="0.01" value="0.1"></td><td class="no-right-border"><input type="number" step="0.001"></td><td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'curve')">Ã—</button></td></tr>
                <tr><td><input type="number" step="0.01" value="0.2"></td><td class="no-right-border"><input type="number" step="0.001"></td><td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'curve')">Ã—</button></td></tr>
                <tr><td><input type="number" step="0.01" value="0.4"></td><td class="no-right-border"><input type="number" step="0.001"></td><td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'curve')">Ã—</button></td></tr>
                <tr><td><input type="number" step="0.01" value="0.8"></td><td class="no-right-border"><input type="number" step="0.001"></td><td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'curve')">Ã—</button></td></tr>
            </tbody>
        </table>
        
        <div class="btn-row">
            <button class="btn-add" onclick="addCurveRow()">+ åŠ ä¸€è¡Œ</button>
        </div>

        <button class="btn-success" onclick="fitCurve()">âš¡ æ‹Ÿåˆæ›²çº¿ & åŒæ­¥å‚æ•°</button>

        <div id="fit-status">
            <div>æ–¹ç¨‹: <span id="eq-display" style="font-family:monospace"></span></div>
            <div>$R^2$: <span id="r2-display"></span></div>
        </div>

        <div class="params-grid" style="margin-top:20px; margin-bottom:0;">
            <div class="input-wrapper">
                <label>æ–œç‡ Slope ($k$)</label>
                <input type="number" id="slope" placeholder="ç­‰å¾…æ‹Ÿåˆ..." step="0.0001" oninput="calculateAll()">
            </div>
            <div class="input-wrapper">
                <label>æˆªè· Intercept ($b$)</label>
                <input type="number" id="intercept" placeholder="ç­‰å¾…æ‹Ÿåˆ..." value="0" step="0.0001" oninput="calculateAll()">
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>2. äº§ç‡è®¡ç®— <span class="tag">Calculation</span></h2>
        
        <div class="params-grid">
            <div class="input-wrapper">
                <label>æ•è·æ¶²ä½“ç§¯ $V$ (mL)</label>
                <input type="number" id="volume" value="30" oninput="calculateAll()">
            </div>
            <div class="input-wrapper">
                <label>å‚¬åŒ–å‰‚ç”¨é‡ $m_{cat}$ (mg)</label>
                <input type="number" id="catalyst" value="160" oninput="calculateAll()">
            </div>
            <div class="input-wrapper">
                <label>ç©ºç™½å¸å…‰åº¦ $A_b$ (Abs)</label>
                <input type="number" id="blank_abs" value="0" oninput="calculateAll()">
            </div>
        </div>

        <table class="data-table" id="calcTable">
            <thead>
                <tr>
                    <th style="width:50px">åºå·</th>
                    <th style="width:25%">é‡‡æ ·æ—¶é—´ $t$ <br>(h)</th>
                    <th style="width:25%">å¸å…‰åº¦ $A_w$ <br>(Abs)</th>
                    <th class="no-right-border">æ‘©å°”äº§ç‡ $y$ <br>($\mu mol \cdot g^{-1} \cdot h^{-1}$)</th>
                    <th class="no-left-border" style="width:50px"></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="index-cell">1</td>
                    <td><input type="number" step="0.1" value="2" oninput="calculateAll()"></td>
                    <td><input type="number" step="0.001" oninput="calculateAll()"></td>
                    <td class="result-cell no-right-border">-</td>
                    <td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'calc')">Ã—</button></td>
                </tr>
            </tbody>
        </table>

        <div class="btn-row">
            <button class="btn-add" onclick="addCalcRow()">+ åŠ ä¸€è¡Œæ•°æ®</button>
        </div>
        
        <p style="font-size:12px; color:#999; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <strong>å‚è€ƒæ ‡å‡†ï¼š</strong> GB 17378.4-2007 æµ·æ´‹ç›‘æµ‹è§„èŒƒ ç¬¬4éƒ¨åˆ†ï¼šæµ·æ°´åˆ†æ<br>
            <strong>è®¡ç®—å…¬å¼ï¼š</strong> $Rate = \frac{n_{NH_3}}{m_{cat} \times t}$ï¼Œå…¶ä¸­ $t$ ä¸ºå¡«å†™çš„é‡‡æ ·æ—¶é—´ (h)
        </p>
    </div>
</div>

<script>
    // --- å¼¹çª—æ§åˆ¶ ---
    function openModal() {
        document.getElementById('guideModal').style.display = 'flex';
        if (window.MathJax) window.MathJax.typesetPromise(); // ç¡®ä¿å¼¹çª—å†…çš„å…¬å¼æ¸²æŸ“
    }

    function closeModal(e) {
        if (e.target.id === 'guideModal') {
            document.getElementById('guideModal').style.display = 'none';
        }
    }

    // --- è¡¨æ ¼æ“ä½œ ---
    
    function reindexRows() {
        const rows = document.querySelectorAll('#calcTable tbody tr');
        rows.forEach((row, index) => {
            row.querySelector('.index-cell').innerText = index + 1;
        });
    }

    function delRow(btn, type) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
        if (type === 'calc') {
            reindexRows();
            calculateAll();
        }
    }

    function addCurveRow() {
        const tbody = document.querySelector('#curveTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="number" step="0.01"></td>
            <td class="no-right-border"><input type="number" step="0.001"></td>
            <td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'curve')">Ã—</button></td>
        `;
        tbody.appendChild(tr);
    }

    function addCalcRow() {
        const tbody = document.querySelector('#calcTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="index-cell"></td>
            <td><input type="number" step="0.1" value="2" oninput="calculateAll()"></td>
            <td><input type="number" step="0.001" oninput="calculateAll()"></td>
            <td class="result-cell no-right-border">-</td>
            <td class="no-left-border"><button class="btn-del" onclick="delRow(this, 'calc')">Ã—</button></td>
        `;
        tbody.appendChild(tr);
        reindexRows();
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---

    function fitCurve() {
        const rows = document.querySelectorAll('#curveTable tbody tr');
        let xData = [], yData = [];

        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const x = parseFloat(inputs[0].value);
            const y = parseFloat(inputs[1].value);
            if (!isNaN(x) && !isNaN(y)) {
                xData.push(x);
                yData.push(y);
            }
        });

        if (xData.length < 2) {
            alert("è¯·è‡³å°‘è¾“å…¥2ç»„æœ‰æ•ˆæ•°æ®è¿›è¡Œæ‹Ÿåˆ");
            return;
        }

        const n = xData.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
        for (let i = 0; i < n; i++) {
            sumX += xData[i];
            sumY += yData[i];
            sumXY += xData[i] * yData[i];
            sumXX += xData[i] * xData[i];
            sumYY += yData[i] * yData[i];
        }

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        const numerator = (n * sumXY - sumX * sumY);
        const denominator = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
        const r2 = Math.pow(numerator / denominator, 2);

        const slopeInput = document.getElementById('slope');
        const intInput = document.getElementById('intercept');
        
        slopeInput.value = slope.toFixed(4);
        intInput.value = intercept.toFixed(4);
        slopeInput.classList.add('auto-filled');
        intInput.classList.add('auto-filled');
        
        const statusDiv = document.getElementById('fit-status');
        statusDiv.style.display = 'block';
        document.getElementById('eq-display').innerText = `y = ${slope.toFixed(4)}x + (${intercept.toFixed(4)})`;
        document.getElementById('r2-display').innerText = r2.toFixed(5);
        
        if (window.MathJax) window.MathJax.typesetPromise();
        calculateAll();
    }

    function calculateAll() {
        const slope = parseFloat(document.getElementById('slope').value);
        const intercept = parseFloat(document.getElementById('intercept').value);
        const vol = parseFloat(document.getElementById('volume').value);
        const catMg = parseFloat(document.getElementById('catalyst').value);
        const blankAbs = parseFloat(document.getElementById('blank_abs').value) || 0;

        if (!slope || !vol || !catMg) {
            return;
        }

        const catG = catMg / 1000;
        const rows = document.querySelectorAll('#calcTable tbody tr');
        
        rows.forEach((row) => {
            const inputs = row.querySelectorAll('input');
            const time = parseFloat(inputs[0].value);
            const abs = parseFloat(inputs[1].value);
            const resultCell = row.querySelector('.result-cell');

            if (isNaN(time) || isNaN(abs) || time <= 0) {
                resultCell.innerText = "-";
                return;
            }

            let netAbs = abs - blankAbs;
            let conc = (netAbs - intercept) / slope;
            if (conc < 0) conc = 0;

            let massN = conc * vol; // Î¼g
            let molNH3 = massN / 14.007; // Î¼mol
            let yieldRate = molNH3 / (catG * time);

            resultCell.innerText = yieldRate.toFixed(3);
        });
    }
</script>

</body>
</html>
